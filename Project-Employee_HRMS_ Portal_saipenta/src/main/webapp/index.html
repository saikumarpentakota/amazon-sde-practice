<!DOCTYPE html>
<html>
<head>
    <title>HRMS Portal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; background: white; border-radius: 8px; }
        .header { background: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 8px; }
        button { padding: 10px 15px; margin: 5px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #2980b9; }
        .success { background: #27ae60; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .form-group { margin: 10px 0; }
        .data-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .data-table th, .data-table td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .data-table th { background: #34495e; color: white; }
        .loading { color: #3498db; font-style: italic; }
        .error { color: #e74c3c; background: #fdf2f2; padding: 10px; border-radius: 4px; }
        .success-msg { color: #27ae60; background: #f0f9f0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>HR Management System</h1>
            <p>Real-time MySQL & DynamoDB Integration</p>
        </div>
        
        <div class="section">
            <h2>Employee Management</h2>
            <div class="form-group">
                <button onclick="loadEmployees()">Load All Employees</button>
                <button onclick="showAddForm()">Add New Employee</button>
            </div>

            <div id="addForm" style="display:none; margin: 15px 0; padding: 15px; background: #ecf0f1; border-radius: 4px;">
                <h3>Add New Employee</h3>
                <input type="text" id="empName" placeholder="Full Name">
                <input type="email" id="empEmail" placeholder="Email Address">
                <select id="empDept">
                    <option value="1">IT Department</option>
                    <option value="2">HR Department</option>
                    <option value="3">Finance Department</option>
                </select>
                <input type="number" id="empSalary" placeholder="Salary">
                <button onclick="addEmployee()" class="success">Save Employee</button>
                <button onclick="hideAddForm()">Cancel</button>
            </div>

            <div id="employees">Click "Load All Employees" to view data</div>
        </div>

        <div class="section">
            <h2>Payroll Processing</h2>
            <div class="form-group">
                <input type="text" id="empId" placeholder="Employee ID">
                <input type="text" id="month" placeholder="YYYY-MM" value="2024-01">
                <input type="number" id="overtime" placeholder="Overtime Amount" value="0">
                <button onclick="calculatePayroll()">Calculate Payroll</button>
            </div>
            <div id="payrollResult"></div>
        </div>

        <div class="section">
            <h2>Attendance Management</h2>
            <div class="form-group">
                <input type="number" id="attEmpId" placeholder="Employee ID">
                <input type="time" id="checkIn" value="09:00">
                <input type="time" id="checkOut" value="17:00">
                <button onclick="recordAttendance()">Record Attendance</button>
            </div>
            <div id="attendanceResult"></div>
        </div>

        <div class="section">
            <h2>Batch Processing</h2>
            <div class="form-group">
                <button onclick="queueAll()">Queue All Employees</button>
                <button onclick="processBatch()">Process Batch</button>
                <button onclick="getQueueSize()">Check Queue Size</button>
            </div>
            <div id="batchResult"></div>
        </div>
    </div>

    <script>

        const API_BASE = '/HRMSPROJECT-1.0-SNAPSHOT/api';

        // Debug function to test different paths
        function testPaths() {
            const paths = [
                '/HRMSPROJECT-1.0-SNAPSHOT/api/employees',
                '/api/employees',
                '/employees'
            ];
            paths.forEach(path => {
                fetch(path)
                    .then(r => console.log(`${path}: ${r.status}`))
                    .catch(e => console.log(`${path}: FAILED`));
            });
        }

        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = '<div class="loading">â³ Loading data...</div>';
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `<div class="error">âŒ Error: ${message}</div>`;
        }

        function showSuccess(elementId, message) {
            document.getElementById(elementId).innerHTML = `<div class="success-msg">âœ… ${message}</div>`;
        }

        function loadEmployees() {
            showLoading('employees');
            fetch(`${API_BASE}/employees`)
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', [...response.headers.entries()]);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Employee data:', data);
                    if (!Array.isArray(data) || data.length === 0) {
                        document.getElementById('employees').innerHTML = '<p>No employees found</p>';
                        return;
                    }
                    displayEmployeeTable(data);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    showError('employees', `Failed to load employees: ${error.message}`);
                });
        }

        function showAddForm() {
            document.getElementById('addForm').style.display = 'block';
        }

        function hideAddForm() {
            document.getElementById('addForm').style.display = 'none';
        }

        function displayEmployeeTable(data) {
            let html = '<table class="data-table"><tr><th>ID</th><th>Name</th><th>Email</th><th>Department</th><th>Salary</th><th>Join Date</th></tr>';
            data.forEach(emp => {
                html += `<tr><td>${emp.id}</td><td>${emp.name}</td><td>${emp.email}</td><td>${emp.departmentId}</td><td>$${emp.salary}</td><td>${emp.joinDate}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('employees').innerHTML = html;
        }

        function addEmployee() {
            const employee = {
                name: document.getElementById('empName').value,
                email: document.getElementById('empEmail').value,
                departmentId: document.getElementById('empDept').value,
                salary: parseFloat(document.getElementById('empSalary').value),
                joinDate: new Date().toISOString().split('T')[0]
            };

            fetch(`${API_BASE}/employees`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(employee)
            })
            .then(response => response.json())
            .then(data => {
                showSuccess('employees', `Employee ${employee.name} added successfully!`);
                hideAddForm();
                loadEmployees();
            })
            .catch(error => showError('employees', 'Failed to add employee'));
        }

        function calculatePayroll() {
            const empId = document.getElementById('empId').value;
            const month = document.getElementById('month').value;
            const overtime = document.getElementById('overtime').value || 0;

            if (!empId || !month) {
                showError('payrollResult', 'Please enter Employee ID and Month');
                return;
            }

            showLoading('payrollResult');
            fetch(`${API_BASE}/payroll/generate?employeeId=${empId}&month=${month}&overtime=${overtime}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.payroll) {
                    const p = data.payroll;
                    let html = `<div class="success-msg"><h3>ðŸ’° Payroll Generated Successfully</h3>`;
                    html += `<p><strong>Employee ID:</strong> ${p.employeeId}</p>`;
                    html += `<p><strong>Month:</strong> ${p.month}</p>`;
                    html += `<p><strong>Basic Salary:</strong> $${p.basicSalary}</p>`;
                    html += `<p><strong>Allowances:</strong> $${p.allowances || 0}</p>`;
                    html += `<p><strong>Deductions:</strong> $${p.deductions || 0}</p>`;
                    html += `<p><strong>Overtime:</strong> $${p.overtime}</p>`;
                    html += `<p><strong>Total:</strong> $${p.total}</p></div>`;
                    document.getElementById('payrollResult').innerHTML = html;
                } else {
                    showError('payrollResult', data.error || 'Payroll calculation failed');
                }
            })
            .catch(error => showError('payrollResult', 'Failed to calculate payroll'));
        }

        function loadMonthlyReport() {
            const month = document.getElementById('month').value;
            if (!month) {
                showError('payrollResult', 'Please enter month (YYYY-MM)');
                return;
            }

            showLoading('payrollResult');
            fetch(`${API_BASE}/payroll/month/${month}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        document.getElementById('payrollResult').innerHTML = '<p>No payroll data found for this month</p>';
                        return;
                    }

                    let html = '<h3>ðŸ“Š Monthly Payroll Report</h3><table class="data-table"><tr><th>Employee</th><th>Email</th><th>Basic Salary</th><th>Overtime</th><th>Total</th></tr>';
                    data.forEach(p => {
                        html += `<tr><td>${p.employeeName}</td><td>${p.employeeEmail}</td><td>$${p.basicSalary}</td><td>$${p.overtime}</td><td>$${p.total}</td></tr>`;
                    });
                    html += '</table>';
                    document.getElementById('payrollResult').innerHTML = html;
                })
                .catch(error => showError('payrollResult', 'Failed to load monthly report'));
        }

        function recordAttendance() {
            const empId = document.getElementById('attEmpId').value;
            const checkIn = document.getElementById('checkIn').value;
            const checkOut = document.getElementById('checkOut').value;

            if (!empId || !checkIn || !checkOut) {
                showError('attendanceResult', 'Please fill all attendance fields');
                return;
            }

            showLoading('attendanceResult');
            
            const formData = new FormData();
            formData.append('employeeId', empId);
            formData.append('checkIn', checkIn);
            formData.append('checkOut', checkOut);
            
            fetch(`${API_BASE}/attendance`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                showSuccess('attendanceResult', `Attendance recorded for Employee ${empId}`);
            })
            .catch(error => showError('attendanceResult', `Failed to record attendance: ${error.message}`));
        }

        function loadAttendance() {
            const empId = document.getElementById('attEmpId').value;
            if (!empId) {
                showError('attendanceResult', 'Please enter Employee ID');
                return;
            }

            showLoading('attendanceResult');
            fetch(`${API_BASE}/attendance/employee/${empId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        document.getElementById('attendanceResult').innerHTML = '<p>No attendance records found</p>';
                        return;
                    }

                    let html = '<h3>â° Attendance Records (MySQL)</h3><table class="data-table"><tr><th>Date</th><th>Check In</th><th>Check Out</th><th>Hours</th></tr>';
                    data.forEach(att => {
                        html += `<tr><td>${att.date}</td><td>${att.checkIn}</td><td>${att.checkOut}</td><td>${att.hoursWorked}</td></tr>`;
                    });
                    html += '</table>';
                    document.getElementById('attendanceResult').innerHTML = html;
                })
                .catch(error => showError('attendanceResult', 'Failed to load attendance'));
        }

        function submitLeave() {
            const leave = {
                employeeId: parseInt(document.getElementById('leaveEmpId').value),
                leaveType: document.getElementById('leaveType').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                reason: document.getElementById('reason').value
            };

            if (!leave.employeeId || !leave.startDate || !leave.endDate) {
                showError('leaveResult', 'Please fill all required fields');
                return;
            }

            fetch(`${API_BASE}/leave`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(leave)
            })
            .then(response => response.json())
            .then(data => {
                showSuccess('leaveResult', 'Leave request submitted successfully to DynamoDB!');
            })
            .catch(error => showError('leaveResult', 'Failed to submit leave request'));
        }

        function loadLeaveRequests() {
            showLoading('leaveResult');
            fetch(`${API_BASE}/leave`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        document.getElementById('leaveResult').innerHTML = '<p>No leave requests found</p>';
                        return;
                    }

                    let html = '<h3>ðŸ–ï¸ Leave Requests (DynamoDB)</h3><table class="data-table"><tr><th>ID</th><th>Employee</th><th>Type</th><th>Start</th><th>End</th><th>Status</th></tr>';
                    data.forEach(leave => {
                        html += `<tr><td>${leave.id}</td><td>${leave.employeeId}</td><td>${leave.leaveType}</td><td>${leave.startDate}</td><td>${leave.endDate}</td><td>${leave.status || 'PENDING'}</td></tr>`;
                    });
                    html += '</table>';
                    document.getElementById('leaveResult').innerHTML = html;
                })
                .catch(error => showError('leaveResult', 'Failed to load leave requests'));
        }

        function queueAll() {
            showLoading('batchResult');
            fetch(`${API_BASE}/batch/queue-all`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showSuccess('batchResult', data.message || 'All employees queued for batch processing');
                })
                .catch(error => showError('batchResult', 'Failed to queue employees'));
        }

        function processBatch() {
            const month = document.getElementById('month').value || new Date().toISOString().slice(0, 7);
            showLoading('batchResult');
            fetch(`${API_BASE}/batch/process?month=${month}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showSuccess('batchResult', `Batch processing completed! ${data.message || 'Payroll generated for all employees'}`);
                })
                .catch(error => showError('batchResult', 'Failed to process batch'));
        }

        function getQueueSize() {
            fetch(`${API_BASE}/batch/queue-size`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('batchResult').innerHTML = `<div class="success-msg">ðŸ“Š Current Queue Size: ${data.size || 0} employees</div>`;
                })
                .catch(error => showError('batchResult', 'Failed to get queue size'));
        }

        // Auto-load employees on page load
        window.onload = function() {
            console.log('Testing API endpoint...');
            fetch(`${API_BASE}/employees`, { method: 'OPTIONS' })
                .then(response => {
                    console.log('OPTIONS response:', response.status);
                    console.log('CORS headers:', response.headers.get('Access-Control-Allow-Origin'));
                })
                .catch(error => console.error('CORS preflight failed:', error));
            loadEmployees();
        };
    </script>
</body>
</html>